<!DOCTYPE html>
<!-- 1. Language changed to English -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 2. Title translated -->
    <title>Your Interactive Ebook Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
        }
        .book-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .book-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Navbar -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <!-- 3. Title translated -->
            <a href="#" class="font-bold text-2xl text-indigo-600">e-Library</a>
            <div>
                <span id="authStatus" class="text-gray-600 mr-4"></span>
                <!-- 4. Button text translated -->
                <button id="loginRegisterBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                    Register / Log In
                </button>
                <!-- 5. Button text translated -->
                <button id="logoutBtn" class="hidden bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                    Log Out
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Page (For Logged Out Users) -->
    <main id="loggedOutView" class="container mx-auto px-6 py-12">
        <!-- Hero Section -->
        <section class="text-center">
            <!-- 6. Content translated -->
            <h1 class="text-4xl md:text-6xl font-bold text-gray-900 leading-tight mb-4">Explore a Boundless World of Stories</h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto mb-8">Get exclusive access to our ebook collection. Register for free to start reading, save favorites, and receive personalized book recommendations just for you.</p>
            <button id="ctaRegisterBtn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-indigo-700 transition transform hover:scale-105">
                Register Now for Free
            </button>
        </section>
        
        <!-- UPDATED: Featured Collection (Bookcase) -->
        <section class="mt-20">
            <!-- 7. Content translated -->
            <h2 class="text-3xl font-bold text-center text-gray-900 mb-10">Our Featured Collection</h2>
            <!-- UPDATED: Denser grid (up to 6 per row) -->
            <div id="sampleBookGrid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                <!-- Sample books will be loaded here by JavaScript -->
            </div>
            <div class="text-center mt-12">
                <!-- 8. Content translated -->
                <button id="ctaRegisterBtnBottom" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-indigo-700 transition transform hover:scale-105">
                    Register to See More
                </button>
            </div>
        </section>
    </main>

    <!-- Library Page (For Logged In Users) -->
    <main id="loggedInView" class="hidden container mx-auto px-6 py-12">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
            <!-- 9. Content translated -->
            <h1 id="welcomeMessage" class="text-3xl font-bold">Loading Library...</h1>
            <a href="https://anyflip.com/bookcase/icnak" target="_blank" rel="noopener noreferrer" class="mt-4 sm:mt-0 bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                <!-- 10. Content translated -->
                <i class="fas fa-layer-group mr-2"></i>View Full Bookcase
            </a>
        </div>

        <!-- UPDATED: Infographic Stats Section -->
        <section id="statsSection" class="my-8">
            <!-- 11. Content translated -->
            <h2 class="text-2xl font-bold mb-4">Your Statistics</h2>
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Card 1: Favorites -->
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4">
                    <div class="bg-red-100 p-3 rounded-full flex-shrink-0">
                        <i class="fas fa-heart text-red-500 text-2xl w-8 h-8 text-center leading-8"></i>
                    </div>
                    <div>
                        <!-- 12. Content translated -->
                        <p class="text-gray-500 text-sm">Favorite Books</p>
                        <p id="statsFavorites" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <!-- Card 2: Top Genre -->
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4">
                    <div class="bg-blue-100 p-3 rounded-full flex-shrink-0">
                        <i class="fas fa-star text-blue-500 text-2xl w-8 h-8 text-center leading-8"></i>
                    </div>
                    <div>
                        <!-- 13. Content translated -->
                        <p class="text-gray-500 text-sm">Top Genre</p>
                        <p id="statsTopGenre" class="text-2xl font-bold capitalize">-</p>
                    </div>
                </div>
                <!-- Card 3: Total Books -->
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4">
                    <div class="bg-indigo-100 p-3 rounded-full flex-shrink-0">
                        <i class="fas fa-book-bookmark text-indigo-500 text-2xl w-8 h-8 text-center leading-8"></i>
                    </div>
                    <div>
                        <!-- 14. Content translated -->
                        <p class="text-gray-500 text-sm">Books in Library</p>
                        <p id="statsTotalBooks" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-8" aria-label="Tabs">
                <!-- 15. Content translated -->
                <button id="allBooksTab" class="tab-btn text-indigo-600 border-b-2 border-indigo-600 py-4 px-1 text-lg font-medium">All Ebooks</button>
                <button id="favoritesTab" class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-lg font-medium">My Favorites</button>
            </nav>
        </div>

        <!-- Ebook Grid -->
        <div id="ebooksContainer">
            <!-- Loading indicator -->
            <div id="loadingIndicator" class="loader"></div>
            
            <!-- UPDATED: 'allBooksGrid' is now a container for bookshelves, not a grid -->
            <div id="allBooksGrid" class="hidden">
                <!-- Bookshelves by category will be injected here -->
            </div>
            <!-- UPDATED: Denser grid (up to 6 per row) -->
            <div id="favoritesGrid" class="hidden grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                <!-- Favorite ebook cards will be injected here -->
            </div>
             <!-- 16. Content translated -->
             <p id="allBooksEmpty" class="hidden text-center text-gray-500 mt-10">No ebooks found. Please add ebooks in the admin page.</p>
             <p id="favoritesEmpty" class="hidden text-center text-gray-500 mt-10">You don't have any favorite books yet.</p>
        </div>
    </main>

    <!-- Registration Modal -->
    <div id="registrationModal" class="hidden fixed inset-0 z-50 overflow-auto flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 m-4 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <!-- 17. Content translated -->
                <h2 class="text-2xl font-bold">Register a New Account</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="registrationForm">
                <div class="mb-4">
                    <!-- 18. Content translated -->
                    <label for="email" class="block text-gray-700 font-medium mb-2">Email Address</label>
                    <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-6">
                    <!-- 19. Content translated -->
                    <label for="password" class="block text-gray-700 font-medium mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" minlength="6" required>
                </div>
                <p id="authError" class="hidden text-red-500 text-sm mb-4"></p>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                    <!-- 20. Content translated -->
                    Register
                </button>
            </form>
        </div>
    </div>
    
    <!-- Ebook Detail Modal -->
    <div id="ebookDetailModal" class="hidden fixed inset-0 z-50 overflow-auto flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-6 m-4 max-w-4xl w-full relative max-h-[90vh] overflow-y-auto">
             <button id="closeDetailModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl z-10">&times;</button>
            <div id="modalContent" class="md:flex md:space-x-8">
                <!-- Content will be injected by JavaScript -->
            </div>
        </div>
    </div>

<!-- Firebase SDK -->
<script type="module">
    // Import necessary functions
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        createUserWithEmailAndPassword,
        signInAnonymously,
        signInWithCustomToken, // Still imported but not used, can be removed
        signOut 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        doc, 
        onSnapshot, 
        setDoc,
        updateDoc,
        arrayUnion,
        arrayRemove,
        getDoc,
        setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

    // --- Firebase Configuration ---
    // Your provided Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDUtYojGMeVDnax4UuBpwyCURJcH18_ZhA",
      authDomain: "e-library-de7af.firebaseapp.com",
      projectId: "e-library-de7af",
      storageBucket: "e-library-de7af.firebasestorage.app",
      messagingSenderId: "229459415793",
      appId: "1:229459415793:web:52ab75e5d10e165738cf50",
      measurementId: "G-G14WKLY40F"
    };

    // --- Firebase Initialization ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const analytics = getAnalytics(app); // Add Analytics
    setLogLevel('Debug'); // Enable logs for debugging

    // --- Global Variables ---
    let ebooks = [];
    let favorites = [];
    let currentUserId = null;
    let userDocRef = null;
    let favoritesDocRef = null;
    let ebooksUnsubscribe = null; // To stop ebook listener
    let favoritesUnsubscribe = null; // To stop favorites listener
    
    // --- Database Location ---
    // Modified path for your personal database
    const ebooksRef = collection(db, "ebooks");

    // --- DOM ELEMENTS ---
    const loggedOutView = document.getElementById('loggedOutView');
    const loggedInView = document.getElementById('loggedInView');
    const loginRegisterBtn = document.getElementById('loginRegisterBtn');
    const ctaRegisterBtn = document.getElementById('ctaRegisterBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const registrationModal = document.getElementById('registrationModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const registrationForm = document.getElementById('registrationForm');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const authStatus = document.getElementById('authStatus');
    const authError = document.getElementById('authError');
    
    const allBooksGrid = document.getElementById('allBooksGrid');
    const favoritesGrid = document.getElementById('favoritesGrid');
    const allBooksEmpty = document.getElementById('allBooksEmpty');
    const favoritesEmpty = document.getElementById('favoritesEmpty');
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    // --- UPDATED: New DOM Elements ---
    const sampleBookGrid = document.getElementById('sampleBookGrid');
    const ctaRegisterBtnBottom = document.getElementById('ctaRegisterBtnBottom');
    
    // --- UPDATED: Stats Elements ---
    const statsFavorites = document.getElementById('statsFavorites');
    const statsTopGenre = document.getElementById('statsTopGenre');
    const statsTotalBooks = document.getElementById('statsTotalBooks');
    
    const allBooksTab = document.getElementById('allBooksTab');
    const favoritesTab = document.getElementById('favoritesTab');

    const ebookDetailModal = document.getElementById('ebookDetailModal');
    const closeDetailModalBtn = document.getElementById('closeDetailModalBtn');
    const modalContent = document.getElementById('modalContent');

    // --- MAIN FUNCTIONS ---

    // 1. Monitor Authentication State
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // User is logged in
            currentUserId = user.uid;
            
            // Determine document reference for user data
            favoritesDocRef = doc(db, `users/${currentUserId}`);
            
            isLoggedInUI(user);
            // await listenForEbooks(); // MOVED: Not needed to call here anymore
            await listenForFavorites(); // Start listening for favorites data
            
        } else {
            // No user logged in
            currentUserId = null;
            favoritesDocRef = null; // UPDATED: Set to null
            isLoggedOutUI();
            // Stop all listeners on log out
            // if (ebooksUnsubscribe) ebooksUnsubscribe(); // MOVED: ebook listener stays active
            if (favoritesUnsubscribe) favoritesUnsubscribe();
        }
    });

    // 2. Function to Log In / Register
    async function handleInitialAuth() {
        try {
            // UPDATED: 
            // Removed `signInAnonymously` to force registration.
            // onAuthStateChanged will handle the UI based on
            // whether the user is logged in or not.
            console.log("Checking auth state...");
        } catch (error) {
            console.error("Authentication error:", error);
            // 21. JS message translated
            authStatus.textContent = "Failed to log in.";
        }
    }
    
    // 3. Email & Password Registration
    registrationForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        authError.classList.add('hidden');

        try {
            // Create new user
            // Note: Firebase will log in the new user automatically
            await createUserWithEmailAndPassword(auth, email, password);
            hideRegistrationModal();
        } catch (error) {
            console.error("Registration error:", error.message);
            // 22. JS message translated
            authError.textContent = "Registration failed. Email may already be in use.";
            authError.classList.remove('hidden');
        }
    });

    // 4. Log Out
    logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            // UPDATED: Remove `handleInitialAuth()`.
            // onAuthStateChanged will handle the UI after log out
            // and will display the main page (loggedOutView).
        } catch (error) {
            console.error("Sign out error:", error);
        }
    });
    
    // 5. Start Listening for Ebook Data from Firebase
    async function listenForEbooks() {
        loadingIndicator.classList.remove('hidden');
        allBooksGrid.classList.add('hidden');
        allBooksEmpty.classList.add('hidden');
        
        if (ebooksUnsubscribe) ebooksUnsubscribe(); // Stop old listener if it exists

        ebooksUnsubscribe = onSnapshot(ebooksRef, (querySnapshot) => {
            ebooks = [];
            querySnapshot.forEach((doc) => {
                // Save data AND document ID
                ebooks.push({ id: doc.id, ...doc.data() });
            });
            
            // 23. JS message translated
            console.log("Ebooks loaded:", ebooks.length);
            renderAllBooks(); // Call render every time data changes
            renderSampleBooks(); // <-- UPDATED: Call render for samples
            renderInfographics(); // Call render stats
            
            loadingIndicator.classList.add('hidden');
            if (ebooks.length === 0) {
                allBooksEmpty.classList.remove('hidden');
                allBooksGrid.classList.add('hidden');
            } else {
                allBooksEmpty.classList.add('hidden');
                allBooksGrid.classList.remove('hidden');
            }

        }, (error) => {
            console.error("Error listening to ebooks:", error);
            loadingIndicator.classList.add('hidden');
            // 24. JS message translated
            allBooksEmpty.textContent = "Failed to load ebooks.";
            allBooksEmpty.classList.remove('hidden');
        });
    }

    // 6. Start Listening for Favorites Data from Firebase
    async function listenForFavorites() {
        if (favoritesUnsubscribe) favoritesUnsubscribe(); // Stop old listener
        
        if (!favoritesDocRef) return; // Ensure reference exists

        favoritesUnsubscribe = onSnapshot(favoritesDocRef, (doc) => {
            if (doc.exists()) {
                // Get the 'list' array from the document, if it doesn't exist, use empty array
                favorites = doc.data().list || [];
            } else {
                // Document does not exist yet
                favorites = [];
            }
            // 25. JS message translated
            console.log("Favorites loaded:", favorites.length);
            renderInfographics(); // <-- UPDATED: Call render stats

            // Re-render books to update heart icons
            if (!allBooksGrid.classList.contains('hidden')) {
                renderAllBooks();
            }
            if (!favoritesGrid.classList.contains('hidden')) {
                renderFavorites();
            }
            updateDetailModalFavoriteButton(); // Update modal if it's open

        }, (error) => {
            console.error("Error listening to favorites:", error);
        });
    }
    
    // --- UPDATED: New Function to Render Statistics ---
    function renderInfographics() {
        if (!statsFavorites) return; // Ensure element exists

        // 1. Calculate Favorites
        statsFavorites.textContent = favorites.length;

        // 2. Calculate Total Books
        statsTotalBooks.textContent = ebooks.length;

        // 3. Calculate Top Genre
        const tagCounts = {};
        const favoriteBooks = ebooks.filter(book => favorites.includes(book.id));

        favoriteBooks.forEach(book => {
            if (book.tags && Array.isArray(book.tags)) {
                book.tags.forEach(tag => {
                    const lowerTag = tag.toLowerCase(); // Standardize tag
                    tagCounts[lowerTag] = (tagCounts[lowerTag] || 0) + 1;
                });
            }
        });

        let topGenre = "-";
        let maxCount = 0;
        for (const [genre, count] of Object.entries(tagCounts)) {
            if (count > maxCount) {
                topGenre = genre;
                maxCount = count;
            }
        }
        
        statsTopGenre.textContent = topGenre;
    }

    // 7. Render All Books (For Logged In Dashboard)
    // UPDATED: Organize books by category (bookshelf)
    function renderAllBooks() {
        if (ebooks.length === 0) {
            allBooksGrid.innerHTML = ''; // Clear if no books
            return;
        }
        
        // Group books by category
        const categories = {};
        ebooks.forEach(book => {
            // Use 'Other' if no tags
            const tags = (book.tags && book.tags.length > 0) ? book.tags : ['Other'];
            
            tags.forEach(tag => {
                const cleanTag = tag || 'Other'; // Watch out for null/empty string tags
                
                if (!categories[cleanTag]) {
                    categories[cleanTag] = [];
                }
                // Avoid duplicating books in the same category (if book has multiple tags)
                if (!categories[cleanTag].some(b => b.id === book.id)) {
                     categories[cleanTag].push(book);
                }
            });
        });

        // Sort categories alphabetically, put "Other" at the end
        const sortedCategories = Object.keys(categories).sort((a, b) => {
            if (a === 'Other' && b !== 'Other') return 1;
            if (b === 'Other' && a !== 'Other') return -1;
            return a.localeCompare(b);
        });

        let html = '';
        // Create HTML for each category shelf
        sortedCategories.forEach(category => {
            html += `
                <section class="mb-10">
                    <h2 class="text-2xl font-bold mb-4 capitalize">${category}</h2>
                    <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                        ${categories[category].map(createBookCard).join('')}
                    </div>
                </section>
            `;
        });
        
        allBooksGrid.innerHTML = html;
    }
    
    // --- UPDATED: New Function to Render Sample Books ---
    function renderSampleBooks() {
        if (!sampleBookGrid) return; // Ensure element exists
        // Display first 5 books as samples
        const sampleBooks = ebooks.slice(0, 5);
        if (sampleBooks.length > 0) {
            sampleBookGrid.innerHTML = sampleBooks.map(createBookCard).join('');
        } else {
            // 26. JS message translated
            sampleBookGrid.innerHTML = `<p class="text-center col-span-full text-gray-500">No sample books at this time.</p>`;
        }
    }

    // 8. Render Favorite Books
    function renderFavorites() {
        // 'ebooks' is now global data from Firebase
        const favoriteBooks = ebooks.filter(book => favorites.includes(book.id));
        
        if (favoriteBooks.length > 0) {
            favoritesGrid.innerHTML = favoriteBooks.map(createBookCard).join('');
            favoritesEmpty.classList.add('hidden');
        } else {
            favoritesGrid.innerHTML = '';
            favoritesEmpty.classList.remove('hidden');
        }
    }

    // 9. Create Book Card (Helper)
    function createBookCard(book) {
        // 'favorites' is now global data from Firebase
        const isFavorite = favorites.includes(book.id);
        const heartIconClass = isFavorite ? 'fas text-red-500' : 'far';
        
        // Use Firebase document ID as data-id
        // UPDATED: Smaller card (p-3, text-sm, text-xs)
        return `
            <div class="book-card bg-white rounded-lg overflow-hidden shadow cursor-pointer relative" data-id="${book.id}">
                <img src="${book.cover}" alt="${book.title}" class="w-full h-auto object-cover aspect-[2/3]">
                <div class="p-3">
                    <h3 class="font-bold text-sm truncate">${book.title}</h3>
                    <p class="text-xs text-gray-500">${book.author}</p>
                </div>
                <button class="favorite-btn absolute top-2 right-2 bg-white/80 rounded-full w-8 h-8 flex items-center justify-center" data-id="${book.id}">
                    <i class="${heartIconClass} fa-heart text-xl"></i>
                </button>
            </div>
        `;
    }

    // 10. Favorite Function (Toggle)
    async function toggleFavorite(bookId) {
        // --- UPDATED: Check if user is logged in ---
        if (!currentUserId || !favoritesDocRef) {
            // 27. JS message translated
            console.log("User not logged in. Displaying registration modal.");
            hideEbookDetail(); // Close preview modal if open
            showRegistrationModal(); // Open registration modal
            return;
        }

        const isFavorite = favorites.includes(bookId);

        try {
            if (isFavorite) {
                // Remove from favorites
                await updateDoc(favoritesDocRef, {
                    list: arrayRemove(bookId)
                });
            } else {
                // Add to favorites
                // Use setDoc + merge to create document if it doesn't exist
                await setDoc(favoritesDocRef, {
                    list: arrayUnion(bookId)
                }, { merge: true });
            }
            // 'onSnapshot' listener will handle UI updates automatically
            // 28. JS message translated
            console.log("Favorites updated in Firebase.");
        } catch (error) {
            // 29. JS message translated
            console.error("Failed to update favorites:", error);
        }
    }

    // 11. Show Ebook Detail
    function showEbookDetail(bookId) {
        const book = ebooks.find(b => b.id === bookId);
        if (!book) return;

        // --- UPDATED: Check login status ---
        const isLoggedIn = !!currentUserId;
        const isFavorite = isLoggedIn ? favorites.includes(book.id) : false;
        
        // Find book recommendations (logic remains the same)
        const recommendedBooks = ebooks.filter(otherBook => 
            otherBook.id !== book.id &&
            otherBook.tags && book.tags && // Ensure tags exist
            otherBook.tags.some(tag => book.tags.includes(tag))
        ).slice(0, 3);

        // 30. JS message translated
        let recommendationsHTML = '<p class="text-gray-500">No recommendations at this time.</p>';
        if (recommendedBooks.length > 0) {
            recommendationsHTML = recommendedBooks.map(recBook => `
                <div class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 cursor-pointer book-card" data-id="${recBook.id}">
                    <img src="${recBook.cover}" class="w-12 h-18 object-cover rounded aspect-[2/3]">
                    <div>
                        <p class="font-semibold">${recBook.title}</p>
                        <p class="text-sm text-gray-500">${recBook.author}</p>
                    </div>
                </div>
            `).join('');
        }

        // --- UPDATED: Button logic based on login status ---
        let readButtonHTML = '';
        let favoriteButtonHTML = '';

        if (isLoggedIn) {
            // User Logged In
            readButtonHTML = `
                <a href="${book.flipbookUrl}" target="_blank" rel="noopener noreferrer" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition inline-block">
                    <!-- 31. Content translated -->
                    <i class="fas fa-book-reader mr-2"></i>Open in AnyFlip
                </a>`;
            favoriteButtonHTML = `
                <button id="detailFavoriteBtn" class="border border-gray-300 font-semibold py-2 px-5 rounded-lg hover:bg-gray-100 transition" data-id="${book.id}">
                    <i class="${isFavorite ? 'fas text-red-500' : 'far'} fa-heart mr-2"></i>
                    <!-- 32. Content translated -->
                    <span id="detailFavoriteText">${isFavorite ? 'In Favorites' : 'Add to Favorites'}</span>
                </button>`;
        } else {
            // User Logged Out (Visitor)
            readButtonHTML = `
                <button id="promptRegisterReadBtn" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 transition inline-block">
                    <!-- 33. Content translated -->
                    <i class="fas fa-lock mr-2"></i>Register to Read
                </button>`;
            favoriteButtonHTML = `
                <button id="detailFavoriteBtn" class="border border-gray-300 font-semibold py-2 px-5 rounded-lg hover:bg-gray-100 transition" data-id="${book.id}">
                    <i class="far fa-heart mr-2"></i>
                    <!-- 34. Content translated -->
                    <span id="detailFavoriteText">Register to Save</span>
                </button>`;
        }

        modalContent.innerHTML = `
            <div class="md:w-1/3 mb-6 md:mb-0">
                <img src="${book.cover}" class="w-full rounded-lg shadow-lg aspect-[2/3] object-cover">
            </div>
            <div class="md:w-2/3">
                <h2 class="text-3xl font-bold mb-2">${book.title}</h2>
                <p class="text-lg text-gray-600 mb-4">by ${book.author}</p>
                <div class="flex items-center space-x-4 mb-6">
                    ${readButtonHTML}
                    ${favoriteButtonHTML}
                </div>
                <!-- 35. Content translated -->
                <h3 class="font-bold text-xl border-b pb-2 mb-3">Synopsis</h3>
                <p class="text-gray-700 mb-8">${book.synopsis}</p>

                <!-- 36. Content translated -->
                <h3 class="font-bold text-xl border-b pb-2 mb-3">Similar Ebooks for You</h3>
                <div class="space-y-3">
                    ${recommendationsHTML}
                </div>
            </div>
        `;
        ebookDetailModal.classList.remove('hidden');

        // --- UPDATED: Add listener for 'Register to Read' button ---
        const promptRegisterReadBtn = document.getElementById('promptRegisterReadBtn');
        if (promptRegisterReadBtn) {
            promptRegisterReadBtn.addEventListener('click', () => {
                hideEbookDetail(); // Close preview modal
                showRegistrationModal(); // Open registration modal
            });
        }
    }

    // 12. Update Favorite Button in Modal
    function updateDetailModalFavoriteButton() {
        const btn = document.getElementById('detailFavoriteBtn');
        if (!btn) return; // Modal not open

        const bookId = btn.dataset.id;
        const isFavorite = favorites.includes(bookId);
        
        btn.querySelector('i').className = `mr-2 ${isFavorite ? 'fas text-red-500' : 'far'} fa-heart`;
        // 37. Content translated
        document.getElementById('detailFavoriteText').textContent = isFavorite ? 'In Favorites' : 'Add to Favorites';
    }


    // --- UI FUNCTIONS (DISPLAY) ---
    function isLoggedInUI(user) {
        loggedOutView.classList.add('hidden');
        loggedInView.classList.remove('hidden');
        loginRegisterBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        
        if (user.isAnonymous) {
            // This part should no longer be reached
            // 38. JS message translated
            welcomeMessage.textContent = "Welcome, Visitor!";
            authStatus.textContent = "Visitor Mode";
            loginRegisterBtn.classList.remove('hidden'); // Show register button
            logoutBtn.classList.add('hidden'); // Hide log out for anon
        } else {
            // This is the standard display for registered users
            // 39. JS message translated
            welcomeMessage.textContent = `Welcome back, ${user.email.split('@')[0]}!`;
            authStatus.textContent = `Logged in as ${user.email}`;
        }
    }

    function isLoggedOutUI() {
        loggedOutView.classList.remove('hidden');
        loggedInView.classList.add('hidden');
        loginRegisterBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        // 40. JS message translated
        welcomeMessage.textContent = "Loading Library...";
        authStatus.textContent = "Please log in.";
    }

    function showRegistrationModal() {
        registrationModal.classList.remove('hidden');
    }

    function hideRegistrationModal() {
        registrationModal.classList.add('hidden');
        authError.classList.add('hidden');
    }
    
    function hideEbookDetail() {
        ebookDetailModal.classList.add('hidden');
    }


    // --- EVENT LISTENERS ---
    loginRegisterBtn.addEventListener('click', showRegistrationModal);
    // UPDATED: CTA buttons now open the registration modal
    ctaRegisterBtn.addEventListener('click', showRegistrationModal); 
    ctaRegisterBtnBottom.addEventListener('click', showRegistrationModal); // <-- UPDATED
    closeModalBtn.addEventListener('click', hideRegistrationModal);
    
    document.body.addEventListener('click', (e) => {
        const favoriteBtn = e.target.closest('.favorite-btn');
        const bookCard = e.target.closest('.book-card[data-id]'); // Ensure it's a book-card
        const detailFavoriteBtn = e.target.closest('#detailFavoriteBtn');

        if (favoriteBtn) {
            e.stopPropagation(); // Prevent triggering book-card click
            toggleFavorite(favoriteBtn.dataset.id);
        } else if (detailFavoriteBtn) {
             toggleFavorite(detailFavoriteBtn.dataset.id);
        } else if (bookCard && !e.target.closest('.favorite-btn')) {
            showEbookDetail(bookCard.dataset.id);
        }
    });

    closeDetailModalBtn.addEventListener('click', hideEbookDetail);

    // Change Tab
    allBooksTab.addEventListener('click', () => {
        allBooksGrid.classList.remove('hidden');
        favoritesGrid.classList.add('hidden');
        if (ebooks.length === 0) {
            allBooksEmpty.classList.remove('hidden');
        } else {
            allBooksEmpty.classList.add('hidden');
        }
        favoritesEmpty.classList.add('hidden');
        
        allBooksTab.classList.add('text-indigo-600', 'border-indigo-600');
        favoritesTab.classList.remove('text-indigo-600', 'border-indigo-600');
        favoritesTab.classList.add('text-gray-500');
    });

    favoritesTab.addEventListener('click', () => {
        allBooksGrid.classList.add('hidden');
        favoritesGrid.classList.remove('hidden');
        allBooksEmpty.classList.add('hidden');
        
        favoritesTab.classList.add('text-indigo-600', 'border-indigo-600');
        allBooksTab.classList.remove('text-indigo-600', 'border-indigo-600');
        allBooksTab.classList.add('text-gray-500');
        
        renderFavorites(); // Call renderFavorites here
    });

    // --- INITIALIZATION ---
    // Start authentication process when script loads
    handleInitialAuth();
    // --- UPDATED: Call `listenForEbooks` outside auth state ---
    // This will load books for the main page (samples) 
    // and the logged-in page (full library)
    listenForEbooks();

</script>
</body>
</html>

